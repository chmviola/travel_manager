pipeline {
    agent any

    environment {
        COMPOSE_PROJECT_NAME = "travel_manager_dev"
        DJANGO_ENV = "development"
    }

    stages {
        // REMOVIDA A ETAPA DE CHECKOUT MANUAL
        // O Jenkins já fez o checkout automaticamente ao iniciar o job.
        
        stage('Validar Arquivos') {
            steps {
                script {
                    // Vamos listar os arquivos só para garantir que tudo está lá
                    sh 'ls -la'
                    echo 'Verificando se o docker-compose-dev.yml existe...'
                    sh 'ls -la docker-compose-dev.yml'
                }
            }
        }

        stage('Build and Deploy Dev') {
            steps {
                script {
                    echo 'Iniciando deploy do ambiente DEVELOP...'
                    
                    // 1. Derruba containers antigos de dev (se existirem)
                    // O "|| true" evita erro se for a primeira vez
                    sh 'docker compose -f docker-compose-dev.yml down --remove-orphans || true'
                    
                    // 2. Sobe os novos containers recriando o build
                    sh 'docker compose -f docker-compose-dev.yml up -d --build'
                }
            }
        }
        
        stage('Health Check') {
            steps {
                script {
                    echo 'Aguardando containers subirem...'
                    sleep 15
                    // Verifica se o container web dev está rodando
                    sh 'docker ps | grep travel_manager_web_dev'
                }
            }
        }
    }

    post {
        success {
            echo 'Sucesso! O ambiente DEVELOP foi atualizado.'
        }
        failure {
            echo 'FALHA no deploy da branch develop.'
        }
    }
}