{% extends 'base.html' %}
{% load humanize %}
{% load l10n %}
{% load core_extras %}
{% load static %}

{% block page_title %}
    {{ trip.title }} <small class="text-muted" style="font-size: 0.6em;">{{ trip.get_status_display }}</small>
{% endblock %}

{% block header_flags %}
    {% if trip.flags %}
        <div style="border-right: 1px solid #dee2e6; padding-right: 10px; margin-right: 5px;">
        {% for flag_code in trip.flags %}
            <span class="flag-icon flag-icon-{{ flag_code }} shadow-sm" 
                  style="font-size: 1.2em; border-radius: 2px; margin-right: 5px;" 
                  title="Destino"></span>
        {% endfor %}
        </div>
    {% endif %}
{% endblock %}

{% block content %}
<div class="row">
    
    <div class="col-md-6">
        
        <div class="mb-3 d-flex align-items-center">
            
            {% if can_edit %}
            <a href="{% url 'trip_item_create' trip.id %}" class="btn btn-primary btn-sm mr-2">
                <i class="fas fa-plus"></i> Novo Item
            </a>
            {% endif %}

            {% if can_edit %}
            <button type="button" class="btn btn-warning btn-sm shadow-sm mr-2" data-toggle="modal" data-target="#modalAutoItinerary">
                <i class="fas fa-magic mr-1"></i> Sugerir Roteiro IA
            </button>
            {% endif %}

            <a href="{% url 'checklist_view' trip.id %}" class="btn btn-default btn-sm mr-2">
                <i class="fas fa-tasks"></i> Checklist
            </a>
            
            <a href="{% url 'trip_detail_pdf' trip.id %}" target="_blank" class="btn btn-default btn-sm" title="Imprimir Roteiro">
                <i class="fas fa-file-pdf text-danger mr-1"></i> PDF
            </a>
        </div>

        <div id="timelineMap" style="height: 400px; width: 100%; border-radius: 8px; margin-bottom: 20px;">
            <div class="d-flex align-items-center justify-content-center h-100 bg-light text-muted">
                <i class="fas fa-map-marked-alt mr-2"></i> O mapa será carregado aqui...
            </div>
        </div>

        <div class="timeline">
            
            {% regroup items by start_datetime|date:"d/m/Y" as dates %}

            {% for date in dates %}
            <div class="time-label">
                <span class="bg-navy">{{ date.grouper }}</span>
            </div>

            {% for item in date.list %}
            <div>
                <i class="
                    {% if item.item_type == 'FLIGHT' %}fas fa-plane bg-blue
                    {% elif item.item_type == 'HOTEL' %}fas fa-bed bg-maroon
                    {% elif item.item_type == 'RESTAURANT' %}fas fa-utensils bg-orange
                    {% elif item.item_type == 'ACTIVITY' %}fas fa-camera bg-purple
                    {% else %}fas fa-suitcase bg-gray{% endif %}
                "></i>
                
                <div class="timeline-item">
                    <span class="time"><i class="fas fa-clock"></i> {{ item.start_datetime|date:"H:i" }}</span>
                    
                    <h3 class="timeline-header">
                        <strong>{{ item.name }}</strong>
                        
                        {% if item.weather_temp %}
                        <span class="ml-2 badge badge-light border">
                            <img src="http:{{ item.weather_icon }}" width="20" height="20"> 
                            {{ item.weather_temp }}°C - {{ item.weather_condition }}
                        </span>
                        {% endif %}
                    </h3>

                    <div class="timeline-body">
                        {% if item.location_address %}
                            <p class="text-muted mb-2"><i class="fas fa-map-marker-alt mr-1"></i> {{ item.location_address }}</p>
                        {% endif %}
                        
                        {{ item.details.notes|linebreaksbr }}

                        {% if item.total_expenses > 0 %}
                        <div class="mt-2">
                            <span class="badge badge-success">Gastos: R$ {{ item.total_expenses|floatformat:2 }}</span>
                        </div>
                        {% endif %}
                    </div>
                    
                    <div class="timeline-footer">
                        <button type="button" class="btn btn-default btn-sm" 
                                data-toggle="modal" data-target="#modalMap"
                                data-lat="{{ item.location_lat|unlocalize }}"
                                data-lng="{{ item.location_lng|unlocalize }}"
                                data-address="{{ item.location_address }}">
                            <i class="fas fa-map mr-1"></i> Ver no Mapa
                        </button>
                        
                        {% if can_edit %}
                            <a href="{% url 'attachment_list' item.id %}" class="btn btn-default btn-sm">
                                <i class="fas fa-paperclip"></i> Anexos
                            </a>

                            <a href="{% url 'expense_create' item.id %}" class="btn btn-default btn-sm">
                                <i class="fas fa-dollar-sign"></i> Gerenciar Gastos
                            </a>

                            <a href="{% url 'trip_item_update' item.id %}" class="btn btn-warning btn-sm float-right ml-1">
                                <i class="fas fa-pencil-alt"></i>
                            </a>
                            <a href="{% url 'trip_item_delete' item.id %}" class="btn btn-danger btn-sm float-right">
                                <i class="fas fa-trash"></i>
                            </a>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
            {% endfor %}

            <div>
                <i class="fas fa-flag-checkered bg-gray"></i>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        
        <div class="card">
            <div class="card-header border-0">
                <div class="d-flex justify-content-between">
                    <h3 class="card-title">Resumo Financeiro</h3>
                    
                    {% if can_edit %}
                    <a href="{% url 'expense_create_no_item' trip.id %}" class="btn btn-tool btn-sm">
                        <i class="fas fa-plus text-primary"></i> Novo Gasto
                    </a>
                    {% endif %}
                </div>
            </div>
            <div class="card-body table-responsive p-0">
                <table class="table table-striped table-valign-middle">
                    <thead>
                    <tr>
                        <th>Gasto</th>
                        <th>Valor (Orig)</th>
                        <th>Valor (R$)</th>
                        {% if can_edit %}<th>Ações</th>{% endif %}
                    </tr>
                    </thead>
                    <tbody>
                    {% for expense in expenses %}
                    <tr>
                        <td>
                            {{ expense.description }}
                            <small class="d-block text-muted">{{ expense.category }}</small>
                        </td>
                        <td class="text-info">
                            {{ expense.currency }} {{ expense.amount }}
                        </td>
                        <td class="text-success">
                            R$ {{ expense.converted_value|floatformat:2 }}
                        </td>
                        
                        {% if can_edit %}
                        <td>
                            <a href="{% url 'expense_update' expense.id %}" class="text-muted">
                                <i class="fas fa-pencil-alt"></i>
                            </a>
                            <a href="{% url 'expense_delete' expense.id %}" class="text-danger ml-2">
                                <i class="fas fa-trash"></i>
                            </a>
                        </td>
                        {% endif %}
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="{% if can_edit %}4{% else %}3{% endif %}" class="text-center text-muted">Nenhum gasto registrado.</td>
                    </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="card-footer">
                <h5 class="float-right text-success">Total: R$ {{ total_spent_brl|floatformat:2 }}</h5>
                
                <div class="text-muted small">
                   {% for rate_info in trip_rates %}
                       <span class="mr-2">
                           <i class="fas fa-exchange-alt"></i> 1 {{ rate_info.code }} = R$ {{ rate_info.rate|floatformat:2 }}
                       </span>
                   {% endfor %}
                </div>
            </div>
        </div>

        <div class="card card-purple card-outline">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-lightbulb text-warning mr-1"></i> Guia de Bolso (IA)
                </h3>
                <div class="card-tools">
                    {% if can_edit %}
                    <a href="{% url 'trip_generate_insights' trip.id %}" class="btn btn-tool text-purple" title="Atualizar Dicas">
                        <i class="fas fa-sync-alt"></i> Atualizar Dicas
                    </a>
                    {% endif %}
                    
                    <button type="button" class="btn btn-tool" data-card-widget="collapse">
                        <i class="fas fa-minus"></i>
                    </button>
                </div>
            </div>
            
            <div class="card-body p-0">
                {% if trip.ai_insights %}
                <div class="row">
                    <div class="col-md-3 col-sm-6 border-right">
                        <div class="description-block">
                            <h5 class="description-header text-success"><i class="fas fa-coins fa-2x mb-2"></i></h5>
                            <span class="description-text">MOEDA</span>
                            <p class="text-muted mt-2 small px-3">{{ trip.ai_insights.currency_tip }}</p>
                        </div>
                    </div>
                    
                    <div class="col-md-3 col-sm-6 border-right">
                        <div class="description-block">
                            <h5 class="description-header text-info"><i class="fas fa-plug fa-2x mb-2"></i></h5>
                            <span class="description-text">TOMADAS</span>
                            <p class="text-muted mt-2 small px-3">{{ trip.ai_insights.plug }}</p>
                        </div>
                    </div>
                    
                    <div class="col-md-3 col-sm-6 border-right">
                        <div class="description-block">
                            <h5 class="description-header text-warning"><i class="fas fa-language fa-2x mb-2"></i></h5>
                            <span class="description-text">FRASES</span>
                            <p class="text-muted mt-2 small px-3">{{ trip.ai_insights.phrases }}</p>
                        </div>
                    </div>
                    
                    <div class="col-md-3 col-sm-6">
                        <div class="description-block">
                            <h5 class="description-header text-danger"><i class="fas fa-user-shield fa-2x mb-2"></i></h5>
                            <span class="description-text">SEGURANÇA</span>
                            <p class="text-muted mt-2 small px-3">{{ trip.ai_insights.safety }}</p>
                        </div>
                    </div>
                </div>
                <div class="bg-light p-3 text-center text-muted font-italic">
                    <i class="fas fa-info-circle mr-1"></i> {{ trip.ai_insights.curiosity }}
                </div>
                {% else %}
                <div class="text-center p-5">
                    <p class="text-muted">Nenhuma dica gerada para este destino ainda.</p>
                    
                    {% if can_edit %}
                    <a href="{% url 'trip_generate_insights' trip.id %}" class="btn btn-app bg-purple">
                        <i class="fas fa-magic"></i> Gerar Guia Agora
                    </a>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>

    </div>
</div>

<div class="modal fade" id="modalAutoItinerary" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <form action="{% url 'trip_generate_itinerary' trip.id %}" method="POST">
            {% csrf_token %}
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title"><i class="fas fa-magic mr-2"></i>Planejador Automático</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p>A Inteligência Artificial vai analisar seu destino (<strong>{{ trip.title }}</strong>) e a duração da viagem para criar sugestões de passeios dia a dia.</p>
                    
                    <div class="form-group">
                        <label>O que você gosta de fazer?</label>
                        <textarea name="interests" class="form-control" rows="3" placeholder="Ex: Gosto de museus de arte, cafeterias históricas e parques. Não gosto de baladas. Quero um ritmo tranquilo."></textarea>
                    </div>
                    
                    <div class="alert alert-info text-sm">
                        <i class="fas fa-info-circle"></i> Os itens serão adicionados à sua linha do tempo. Você poderá editá-los ou excluí-los depois.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-warning">Gerar Roteiro</button>
                </div>
            </div>
        </form>
    </div>
</div>

<div class="modal fade" id="modalMap" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-map-marker-alt mr-2"></i>Localização</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body p-0">
                <div id="itemMap" style="height: 450px; width: 100%;"></div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&libraries=places"></script>

<script>
    // --- MAPA GERAL DA TIMELINE ---
    function initTimelineMap() {
        const mapEl = document.getElementById('timelineMap');
        if (!mapEl) return;

        const map = new google.maps.Map(mapEl, {
            zoom: 2,
            center: { lat: 20, lng: 0 },
            styles: []
        });

        const bounds = new google.maps.LatLngBounds();
        const geocoder = new google.maps.Geocoder();
        let markersCount = 0;

        // Dados vindos do Django com UNLOCALIZE para corrigir vírgula/ponto
        const locations = [
            {% for item in items %}
            {
                name: "{{ item.name|escapejs }}",
                address: "{{ item.location_address|default:''|escapejs }}",
                lat: "{{ item.location_lat|unlocalize|default:'' }}",  
                lng: "{{ item.location_lng|unlocalize|default:'' }}",
                type: "{{ item.item_type }}"
            },
            {% endfor %}
        ];

        const addMarker = (position, title) => {
            new google.maps.Marker({
                position: position,
                map: map,
                title: title,
                animation: google.maps.Animation.DROP
            });
            bounds.extend(position);
            map.fitBounds(bounds);
            markersCount++;
        };

        locations.forEach((loc, index) => {
            if (loc.lat && loc.lng) {
                const pos = { lat: parseFloat(loc.lat), lng: parseFloat(loc.lng) };
                addMarker(pos, loc.name);
            } 
            else if (loc.address) {
                setTimeout(() => {
                    geocoder.geocode({ 'address': loc.address }, function(results, status) {
                        if (status === 'OK') {
                            addMarker(results[0].geometry.location, loc.name);
                        }
                    });
                }, index * 400);
            }
        });

        if (locations.length === 0) {
            map.setCenter({ lat: 48.8566, lng: 2.3522 });
            map.setZoom(12);
        }
    }

    window.addEventListener('load', initTimelineMap);

    // --- MODAL DO MAPA INDIVIDUAL (Lógica para clicar no botão "Ver no Mapa") ---
    let modalMap;
    let modalMarker;
    let modalGeocoder;

    $('#modalMap').on('shown.bs.modal', function (event) {
        const button = $(event.relatedTarget);
        const latStr = button.data('lat');
        const lngStr = button.data('lng');
        const address = button.data('address');

        const drawMap = (location) => {
            if (!modalMap) {
                modalMap = new google.maps.Map(document.getElementById('itemMap'), {
                    center: location,
                    zoom: 15
                });
                modalMarker = new google.maps.Marker({
                    position: location,
                    map: modalMap
                });
            } else {
                modalMap.setCenter(location);
                modalMap.setZoom(15);
                modalMarker.setPosition(location);
                google.maps.event.trigger(modalMap, "resize");
            }
        };

        if (latStr && lngStr) {
            const location = { lat: parseFloat(latStr), lng: parseFloat(lngStr) };
            drawMap(location);
        } 
        else if (address) {
            if (!modalGeocoder) modalGeocoder = new google.maps.Geocoder();
            
            modalGeocoder.geocode({ 'address': address }, function(results, status) {
                if (status === 'OK') {
                    const location = results[0].geometry.location;
                    drawMap(location);
                } else {
                    alert('Não foi possível encontrar este endereço no mapa.');
                }
            });
        }
    });
</script>
{% endblock %}